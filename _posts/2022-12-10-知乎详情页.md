---
layout:     post
title:      æ‰¿è½½çŸ¥ä¹å›ç­”ã€æ–‡ç« ã€æƒ³æ³•è¯¦æƒ…é¡µäº¿çº§æµé‡çš„çŸ­å®¹å™¨å®ç°
subtitle:   çŸ¥ä¹çŸ­å®¹å™¨å®ç°åŸç†
date:       2022-12-10
author:     æ½˜ä¸–æ°‘
header-img: img/2022-12-10/2022-12-10-çŸ¥ä¹è¯¦æƒ…é¡µ.jpeg
catalog: true
tags:
    - çŸ¥ä¹
    - çŸ­å®¹å™¨
    - è¯¦æƒ…é¡µ
    - å›ç­”
    - æ–‡ç« 
    - WebView
    - ScrollView
---


### èƒŒæ™¯
éšç€çŸ¥ä¹çš„å›ç­”è¶Šæ¥è¶Šæ°´åŒ–ï¼Œç«™å†…åˆ›ä½œè€…å†™çš„å›ç­”çš„é•¿åº¦è¶Šæ¥è¶ŠçŸ­(*ç›®å‰ç»Ÿè®¡ï¼Œå·®ä¸å¤š 70%+ çš„å›ç­”é•¿åº¦ä¸åˆ° 100 å­— ğŸ˜‚*)ï¼›ç›®å‰çº¿ä¸Šçš„å›ç­”è¯¦æƒ…é¡µä¸ç®¡å†…å®¹é•¿çŸ­ï¼Œè¯¦æƒ…é¡µéƒ½æ’‘æ»¡ä¸€å±ï¼Œä¸è¶³ä¸€å±çš„å†…å®¹å‰ç«¯åŒå­¦åœ¨å†…å®¹åé¢æ·»åŠ ç•™ç™½ä¹Ÿè¦è®©é¡µé¢æ’‘æ»¡å±å¹•ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå†…å®¹æ¯”è¾ƒçŸ­çš„å›ç­”ï¼š
![å›¾ç‰‡](/img/2022-12-10/omni_bad_case.png)
ä»ä¸Šé¢ case å¯ä»¥çœ‹å‡ºï¼Œåœ¨å†…å®¹æ¯”è¾ƒçŸ­çš„æƒ…å†µä¸‹ï¼Œåœ¨é¡µé¢ä¸­æ’å…¥å¤§é‡çš„ç©ºç™½ï¼›è¿™æ ·ç™½ç™½æµªè´¹äº†å¾ˆå¤šçš„ç©ºé—´ï¼›   
çº¿ä¸Šè¿™ç§è®©æ¯ä¸ªè¯¦æƒ…é¡µéƒ½æ’‘æ»¡ä¸€å±ï¼Œæ»‘åŠ¨åˆ°è¯¦æƒ…é¡µåº•éƒ¨éœ²å‡ºä¸‹ä¸€ä¸ªå›ç­”ä¸€éƒ¨åˆ†å†…å®¹çš„å®¹å™¨åœ¨çŸ¥ä¹å†…éƒ¨å«åš`è¿ç»­æ¶ˆè´¹å®¹å™¨`ç®€ç§°é•¿å®¹å™¨(*ç›¸å¯¹äºæœ¬æ¬¡è®¾è®¡çš„çŸ­å®¹å™¨ï¼›çŸ¥ä¹å†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨é•¿å®¹å™¨ã€çŸ­å®¹å™¨åŒºåˆ†è¿™2ç§æ¡†æ¶*)ï¼›
è¿™ä¸ª gif æ¼”ç¤ºäº†çº¿ä¸Šé•¿å®¹å™¨çš„äº¤äº’
![çº¿ä¸Šè¿ç»­æ¶ˆè´¹å®¹å™¨](/img/2022-12-10/omni_video.gif)

å…¶å®å¾ˆè‡ªç„¶çš„å¯ä»¥æƒ³åˆ°ï¼Œæ—¢ç„¶å¾ˆå¤šå›ç­”å†…å®¹æ¯”è¾ƒçŸ­ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨å¡ç‰‡æ¥å±•ç¤ºè¿™äº›æ¯”è¾ƒçŸ­çš„å†…å®¹ï¼Œè€Œä¸ç”¨ç»§ç»­ä½¿ç”¨ä¸€æ•´ä¸ªé¡µé¢å±•ç¤ºä¸€ä¸ªå›ç­”ï¼›ç»“åˆçŸ¥ä¹è¯¦æƒ…é¡µçš„ç°çŠ¶(*åœ¨æ¨èé¡µæµé€šçš„éƒ½æ˜¯ä¼˜è´¨å†…å®¹ï¼Œå†…å®¹é•¿åº¦å¤§äº 300 å­—*)ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ–°çš„é¡µé¢æˆ–æ¡†æ¶æ¥å±•ç¤ºè¿™äº›å†…å®¹ï¼Œè¿™ä¸ªæ–°çš„é¡µé¢ç”± 2 éƒ¨åˆ†ç»„æˆï¼š  
1ã€ä¸Šéƒ¨åˆ†å°±æ˜¯çŸ¥ä¹çº¿ä¸Šçš„ç‹¬ç«‹çš„å›ç­”è¯¦æƒ…é¡µã€æ–‡ç« è¯¦æƒ…é¡µã€æƒ³æ³•è¯¦æƒ…é¡µç­‰ç­‰ã€‚åŒ…æ‹¬æ ‡é¢˜ + ä½œè€…ï¼ˆå…³æ³¨ï¼‰+ èµ„è®¯å†…å®¹ + ç›¸å…³æ¨è(å¯é€‰) + å¹¿å‘Š(å¯é€‰) + çƒ­è¯„(å¯é€‰);    
2ã€ä¸‹åŠéƒ¨åˆ†ç´§æ¥ç€ä¸ŠåŠéƒ¨åˆ†ï¼Œä½¿ç”¨ä¸€ä¸ªåˆ—è¡¨é¡µé¢ï¼Œä»¥å¡ç‰‡çš„å½¢å¼å±•ç¤ºåŒé—®é¢˜ä¸‹çš„å›ç­”ã€æ¨èçš„å›ç­”ã€æ–‡ç« å’Œæƒ³æ³•ï¼›

åŒæ—¶è¿™ä¸ªæ–°çš„æ¡†æ¶è¿˜éœ€è¦å¤„ç†ä¸‹é¢è¿™äº›é—®é¢˜ï¼š  
1ã€éœ€è¦åˆç†çš„å¤„ç†ä¸ŠåŠéƒ¨åˆ†è§†å›¾ä¸ä¸‹åŠéƒ¨åˆ†è§†å›¾ååŒæ»šåŠ¨ï¼›  
2ã€æ–¹ä¾¿å›ç­”è¯¦æƒ…é¡µã€æ–‡ç« è¯¦æƒ…é¡µã€æƒ³æ³•è¯¦æƒ…é¡µç­‰ä¸šåŠ¡æ¥å…¥ï¼Œæœ€å¥½è®©ä¸šåŠ¡æ— æ„ŸçŸ¥ï¼›   
3ã€ä¸ŠåŠéƒ¨åˆ†çš„è¯¦æƒ…é¡µï¼Œåœ¨æ¥å…¥çŸ­å®¹å™¨ä¹‹åå»æ‰ç•™ç™½å¯¹ä¸šåŠ¡æ— å½±å“ï¼›  
4ã€æ”¯æŒä¸‹æ‹‰åˆ·æ–°ã€ä¸Šæ‹‰åŠ è½½ï¼›  
5ã€ç‚¹å‡» `next` æŒ‰é’®åˆ‡æ¢åˆ°åˆ—è¡¨é¡µé¢ï¼›  
6ã€æ–¹ä¾¿çš„å®ç°è‡ªå®šä¹‰çš„åŠ¨æ•ˆï¼›

æˆ‘ä»¬å†…éƒ¨æŠŠè¿™ä¸ªæ–°çš„æ¡†æ¶å«åš`çŸ­å®¹å™¨`ï¼Œä¸€ä¸ªçº¯ UI çš„æ¡†æ¶ï¼›

### æŠ€æœ¯æ–¹æ¡ˆè°ƒç ”
ç»è¿‡å¯¹ `ä»Šæ—¥å¤´æ¡`ã€`è…¾è®¯æ–°é—»`ã€`ä¸€ç‚¹èµ„è®¯`ç­‰æ–°é—»èµ„è®¯ç±»`APP`çš„è°ƒç ”ï¼Œå‘ç°å®ƒä»¬çš„å†…å®¹é¡µè¯¦æƒ…é¡µå’Œæˆ‘ä»¬æƒ³è¦å®ç°çš„é¡µé¢æ¯”è¾ƒç±»ä¼¼ï¼›æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ†æå®ƒä»¬çš„å†…å®¹è¯¦æƒ…é¡µæ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¸ºæˆ‘ä»¬å®ç°`çŸ­å®¹å™¨`æ¡†æ¶æä¾›å‚è€ƒ

#### æ–¹æ¡ˆä¸€:
åœ¨ `WebView` çš„åº•éƒ¨ç•™ä¸€ä¸ªç©ºç™½çš„`div`æ§½ä½ï¼Œç”¨äºç¡®å®š`collectionView`çš„ä½ç½®ï¼ŒåŒæ—¶æŠŠ`collectionView`åŠ åˆ°`webView.scrollView`ä¸Šï¼Œåœ¨ç›‘å¬åˆ°`webView.scrollView`çš„`contentSize`å˜åŒ–åï¼Œä¸æ–­è°ƒæ•´`collectionView`çš„ä½ç½®å¯¹åº”äºè¯¥ç©ºç™½`div`çš„ä½ç½®ï¼ŒåŒæ—¶å°†è¯¥`div`çš„å°ºå¯¸è®¾ç½®ä¸º`collectionView`çš„`contentSize`ã€‚è¿˜éœ€è¦é€šè¿‡`UIPanGestureRecognizer`å’Œ`UIDynamicAnimator`æ¨¡æ‹Ÿæ»šåŠ¨äº§ç”Ÿåç§»é‡æ¥é©±åŠ¨`collectionView`æ»‘åŠ¨;
![webview_insert_div](/img/2022-12-10/webview_div.png)
è¿™ä¸ªæ–¹æ¡ˆæ˜¯æˆ‘å‰ä¸œå®¶`ä¸€ç‚¹èµ„è®¯`çš„æ–°é—»è¯¦æƒ…é¡µçš„å®ç°æ–¹æ¡ˆï¼›
è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯å®ç°ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼›   
ç¼ºç‚¹ï¼š
1ã€çµæ´»æ€§æ¯”è¾ƒå·®ï¼Œå¯¹è¯¦æƒ…é¡µä¾µå…¥æ€§æ¯”è¾ƒå¼ºï¼ŒåŒæ—¶è¿˜éœ€è¦å‰ç«¯é…åˆï¼›   
2ã€`WebView` å’Œ `collectionView` è€¦åˆåœ¨ä¸€èµ·ï¼Œè§†å›¾åœ¨æ¸²æŸ“å’Œå±•ç¤ºçš„æ—¶å€™ç›¸äº’å½±å“ï¼›    
3ã€å®ç°å¤æ‚çš„äº¤äº’å¾ˆå›°éš¾ï¼Œå¦‚å¸é¡¶ã€ç‚¹å‡»`next`åˆ‡æ¢åˆ°åˆ—è¡¨é¡µé¢ã€ä¸‹æ‹‰åˆ·æ–°ç­‰ç­‰ï¼›

#### æ–¹æ¡ˆäºŒï¼š
ç”±äºæ²¡æœ‰åœ¨ä»Šæ—¥å¤´æ¡å’Œè…¾è®¯æ–°é—»å‘†è¿‡ï¼Œä¸æ¸…æ¥šå®ƒä»¬çš„è¯¦æƒ…é¡µæ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥å€ŸåŠ© [Lookin](https://lookin.work/) æ¥åˆ†æä¸€ä¸‹
å…³äºå¦‚ä½•ä½¿ç”¨ [Lookin](https://lookin.work/) åˆ†æåˆ«äººå®¶çš„`App`ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¥å‰å†™çš„è¿™ç¯‡æ–‡ç«  [å¦‚ä½•ä½¿ç”¨ Lookin åˆ†æåˆ«äººçš„ APP](https://panshimin.github.io/2020/06/11/Lookin/)

##### ä»Šæ—¥å¤´æ¡
å¤´æ¡è¯¦æƒ…é¡µçš„é¡µé¢å±‚çº§å¦‚ä¸‹ï¼š
![ä»Šæ—¥å¤´æ¡](/img/2022-12-10/jinritoutiao_detail.jpg)
è¡¨é¢ä¸Šçœ‹å¤´æ¡çš„è¯¦æƒ…é¡µå¥½åƒä¹Ÿæ˜¯ä½¿ç”¨`WebView` çš„`div`å ä½æ¥å®ç°çš„ï¼Œå…¶å®ä»”ç»†åˆ†æå¹¶ä¸æ˜¯
![TTArticleWebContentView](/img/2022-12-10/jinritoutiao_layout_v1.jpg)
![SSThemedView](/img/2022-12-10/jinritoutiao_layout_v2.jpg)
1ã€SSThemedView å¹¶ä¸æ˜¯ TTArticleWebContentView æˆ–é‡Œé¢çš„ _BDInternalWKWebView çš„å­ Viewï¼Œè€Œæ˜¯å’Œå®ƒä»¬å¹³çº§çš„ï¼Œéƒ½æ˜¯ TTVContainerScrollViewContentView çš„å­ Viewï¼›   
2ã€ä»è§†å›¾å¸ƒå±€ä¸Šå¯ä»¥çœ‹å‡º SSThemedView æ˜¯ç´§ç´§è´´åœ¨ TTArticleWebContentView åº•éƒ¨ï¼›    
3ã€SSThemedView å’Œ TTVContainerScrollViewContentView éƒ½æ˜¯ TTVContainerScrollView çš„å­è§†å›¾ï¼ŒTTVContainerScrollView æ˜¯ UIScrollView çš„å­ç±»ï¼›

ä»ä¸Šé¢åˆ†æå¯ä»¥å¾—å‡ºå¤´æ¡çš„å®ç°æ–¹æ¡ˆ:   
1ã€ä½¿ç”¨ UIScrollView å……å½“ Containerï¼ŒWebView å’Œ CollectionView æˆ– TableView å……å½“ UIScrollView çš„å­è§†å›¾ï¼›   
2ã€ç¦æ­¢ WebView å’Œ CollectionView çš„æ»šåŠ¨ï¼Œå®ƒä»¬çš„æ»šåŠ¨ç”± Container è¿›è¡Œæ§åˆ¶å’Œè°ƒæ•´ï¼ŒContainer é€šè¿‡ contentOffset å’Œ Frame çš„è®¡ç®—ï¼ŒåŠ¨æ€çš„è°ƒæ•´å­è§†å›¾ç›¸å¯¹ Container çš„ Frame ä»¥åŠè‡ªèº«çš„ ContentOffsetï¼Œä»è€Œå®ç°æ»šåŠ¨æ•ˆæœï¼›

è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹ï¼š    
1ã€æ¯ä¸ªæ¨¡å—çš„å®ç°å®Œå…¨ç‹¬ç«‹ï¼ŒUIå’Œä¸šåŠ¡é€»è¾‘ä¸€ä¸€å¯¹åº”ï¼›    
2ã€å¯¹ WebView çš„æ¸²æŸ“æ²¡æœ‰å¹²æ‰°ï¼Œæ¨¡å—çš„åŠ è½½å’Œå¸ƒå±€å¯ä»¥çµæ´»ç®¡ç†ã€å¤ç”¨ï¼Œæ¨¡å—ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹å†…èšï¼›   
3ã€æ·»åŠ ã€æ›¿æ¢æ¨¡å—ï¼Œå®ç°ä¸Šæ‹‰ã€ä¸‹æ‹‰ç­‰æ“ä½œç®€å•;    
ç¼ºç‚¹ï¼š   
1ã€éœ€è¦å¯¹ SubView ä¸­çš„æ»šåŠ¨è§†å›¾è¿›è¡Œè®¡ç®—ï¼Œåœ¨å®ç°ä¸Šæœ‰ä¸€å®šçš„å¤æ‚åº¦ï¼Œåé¢ä¼šè¯¦ç»†è¯´ä¸€ä¸‹è¿™ä¸ªé—®é¢˜

##### è…¾è®¯æ–°é—»
ä»UIç•Œé¢ä¸Šæ¥çœ‹ï¼Œå…¶å®è…¾è®¯æ–°é—»å’Œå¤´æ¡å®éªŒåŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä½¿ç”¨ UIScrollView åµŒå¥—æ¥å®ç°çš„ï¼Œä¸è¿‡è…¾è®¯æ–°é—»åœ¨ Container é‡Œé¢å¤šæ·»åŠ äº†å‡ ä¸ª SubView;
![è…¾è®¯æ–°é—»](/img/2022-12-10/tengsuxinwen_v1.jpg)

#### æ–¹æ¡ˆä¸‰
æ•´ä¸ªé¡µé¢å®Œå…¨éƒ½ä½¿ç”¨ WebView æ¥å®ç°ï¼Œè¿™ç§æ–¹æ¡ˆæ˜¯æœ€ç®€å•çš„ï¼Œä½†æ˜¯ä¸‹é¢çš„åˆ—è¡¨åŠ è½½å¤ªå¤šå†…å®¹çš„æ—¶å€™é¡µé¢ä¼šå¡ï¼Œä¹Ÿä¸æ–¹ä¾¿å®¢æˆ·ç«¯å®šåˆ¶ä¸€äº›äº¤äº’å’ŒåŠ¨ç”»æ•ˆæœï¼›

#### å…·ä½“å®ç°
é€šè¿‡åˆ†æå¸‚é¢ä¸Šå‡ æ¬¾ä¸»æµçš„æ–°é—»è¯¦æƒ…é¡µçš„å®ç°æ–¹æ¡ˆï¼Œå¤´æ¡å’Œè…¾è®¯æ–°é—»çš„å®ç°æ¯”è¾ƒç¬¦åˆæˆ‘ä»¬ç›®å‰çš„éœ€æ±‚
æ ¹æ®ä¸Šé¢çš„åˆ†æå¯ä»¥ç”»å‡ºåµŒå¥— ScrollView çš„æ¡†æ¶å›¾ï¼ŒContainer çš„æœ€å¤–å±‚æ˜¯ä¸€ä¸ª MainScrollViewï¼Œ WebView å’Œ CollectionView æˆ– TableView å……å½“ SubScrollView å¹³é“ºåœ¨ MainScrollView ä¸Šï¼›
![scrollview_scrollview](/img/2022-12-10/scrollview_scollview.png)

ä¸‹é¢æ¥åˆ†æä¸‹å¦‚ä½•å®ç° SubScrollView çš„ååŒæ»šåŠ¨
##### MainScrollView çš„ contentSize

1ã€ç”±äº MainScrollView ç”¨æ¥æ»šåŠ¨è§†å›¾ï¼Œä¸ºäº†èƒ½å¤Ÿå±•ç¤ºæ‰€æœ‰å†…å®¹ï¼Œé‚£ä¹ˆ MainScrollView çš„ contentSize çš„å¤§å°å¿…é¡»ç­‰äº2ä¸ª SubScrollView çš„ contentSize çš„é«˜åº¦ä¹‹å’Œ(åé¢ä¸ºäº†æè¿°æ–¹ä¾¿ä½¿ç”¨ topScrollView å’Œ bottomScrollView åˆ†åˆ«ä»£è¡¨2ä¸ª SubScrollView)
``` swift
    mainScrollView.contentSize = CGSize(width: self.view.width, height: topScrollViewContentHeight + bottomScrollViewContentHeight)
```

##### MainScrollView çš„ contentOffset
ç”±äº topScrollView çš„ contentOffset çš„å–å€¼èŒƒå›´æ˜¯ï¼š
``` swift
0 ~ (topScrollView.contentOffset - topScrollView.height)
```
bottomScrollView çš„ contentOffset çš„å–å€¼èŒƒå›´æ˜¯ï¼š
``` swift
0 ~ (bottomScrollView.contentOffset - bottomScrollView.height)
```

æŠŠ topScrollView æ”¾åˆ° MainScrollView ä¸Šé¢ä¹‹åï¼ŒtopScrollView çš„ contentOffset çš„æ»šåŠ¨èŒƒå›´å³ MainScrollView çš„ contentOffset.y :
``` swift
0 ~ (topScrollView.contentSize.height - topScrollView.height)
```

æŠŠ bottomScrollView æ”¾åˆ° topScrollView åé¢ä¹‹åï¼ŒbottomScrollView çš„ contentOffset çš„æ»šåŠ¨èŒƒå›´:
``` swift
(MainScrollView.contentSize.height - bottomScrollView.contentSize.height) ~ (MainScrollView.contentSize.height - bottomScrollView.height) 
å³
topScrollView.contentSize.height ~ (topScrollView.contentSize.height + bottomScrollView.contentSize.height - bottomScrollView.height)
```
ä¸‹é¢æ ¹æ®ä¸Šé¢çš„åˆ†æä½¿ç”¨å›¾å½¢å±•ç¤º MainScrollViewã€topScrollViewã€bottomScrollView å®ƒä»¬ contentSize ä¹‹é—´çš„å…³ç³»
![scroll_view_contentsize](/img/2022-12-10/scrollview_contentOffset.png)

ç”±äº topScrollView å’Œ bottomScrollView æ²¡æœ‰å®Œå…¨å±•å¼€ï¼Œé‚£ä¹ˆå¦‚æœè®© topScrollView å’Œ bottomScrollView å¤„äº MainScrollView çš„å¯è§†åŒºé—´å°±éœ€è¦åŠ¨æ€çš„è°ƒæ•´å®ƒä»¬çš„ frame.origin.y å’Œ contentOffsetY

ç”±äº topScrollView å’Œ bottomScrollView çš„é«˜åº¦æ˜¯æ ¹æ®å†…å®¹åŠ¨æ€è®¡ç®—æˆ‘ä»¬éœ€è¦å†å®ƒä»¬çš„ contentSize å˜åŒ–æ—¶è°ƒæ•´ä»–ä»¬çš„å¤§å°ã€‚
1ã€é€šè¿‡ kvo ç›‘å¬ topScrollView ã€bottomScrollView çš„ contentSize çš„å˜åŒ–
``` swift
    private func setupBottomScrollViewKVO(scrollView: UIScrollView?) {
        guard let scrollView = scrollView else {
            return
        }
        
        scrollView.isScrollEnabled = false
        scrollView.panGestureRecognizer.require(toFail: mainScrollView.panGestureRecognizer)

        contentOffsetObserverBottom = scrollView.observe(\.contentOffset, options: [.new, .old], changeHandler: { [weak self] (view, change) in
            self?.omniScrollViewDidScroll(scrollView, with: change)
        })

        contentSizeObserverBottom = scrollView.observe(\.contentSize, options: [.new, .old], changeHandler: { [weak self] (view, change) in
            self?.omniScrollView(scrollView, didContentSizeChanged: change)
        })
    }

```
2ã€åœ¨ç›‘å¬åˆ° topScrollView å’Œ bottomScrollView çš„ contentSize å˜åŒ–ä¹‹åæŠŠå®ƒä»¬çš„å€¼åŠ èµ·æ¥èµ‹å€¼ç»™ MainScrollView çš„ contentSize
``` swift
    func omniScrollView(_ scrollView: UIScrollView, didContentSizeChanged change: NSKeyValueObservedChange<CGSize>) {
        
        if scrollView == mainScrollView {
            return
        }
        
        let topScrollViewContentHeight: CGFloat = self.topScrollView?.contentSize.height ?? 0
        var bottomScrollViewContentHeight: CGFloat = self.bottomScrollView?.contentSize.height ?? 0

        if topScrollViewContentHeight == lastTopScrollViewContentHeight &&
            bottomScrollViewContentHeight == lastBottomScrollViewContentHeight {
            return
        }
        
        lastTopScrollViewContentHeight = topScrollViewContentHeight
        lastBottomScrollViewContentHeight = bottomScrollViewContentHeight
        mainScrollView.contentSize = CGSize(width: self.view.width, height: topScrollViewContentHeight + bottomScrollViewContentHeight)
        var topScrollViewHeight = topScrollViewContentHeight < self.view.height ? topScrollViewContentHeight : self.view.height
        let bottomScrollViewHeight = bottomScrollViewContentHeight < self.view.height ? bottomScrollViewContentHeight : self.view.height
        contentView.height = topScrollViewHeight + bottomScrollViewHeight
        topViewController?.view.height = topScrollViewHeight
        bottomViewController?.view.height = bottomScrollViewHeight
        
        if let topViewBottom = topViewController?.view.bottom {
            bottomViewController?.view.top = topViewBottom
        } else {
            bottomViewController?.view.top = 0
        }
    }
```
ç”±äº topScrollView å’Œ bottomScrollView çš„é«˜åº¦æ˜¯ä¸€å®šçš„ï¼ŒåŒæ—¶ bottomScrollView ä¸€ç›´åœ¨ topScrollView çš„ä¸‹é¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬æ”¾åœ¨ä¸€ä¸ª contentView é‡Œé¢ï¼›è¿™æ ·åœ¨æ»šåŠ¨çš„æ—¶å€™åŠ¨æ€çš„æ”¹å˜ topScrollView å’Œ bottomScrollView çš„ top(*å³ frame.origin.y,åé¢éƒ½ä½¿ç”¨ top ç®€å†™*) ç­‰åŒäºæ”¹å˜ contentView çš„ top; å…³äº contentView çš„ size çš„è®¡ç®—å¯ä»¥å‚è€ƒä¸Šé¢çš„ä»£ç ï¼›æ‰€ä»¥åœ¨ MainScrollView æ»šåŠ¨çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è°ƒæ•´ topScrollView å’Œ
bottomScrollView çš„ offsetY ä»¥åŠ contentView çš„ topï¼›

ä»ä¸Šé¢çš„ ScrollView çš„ contentSize ä¹‹é—´çš„å…³ç³»çš„ç¤ºä¾‹å›¾ä¸Šå¯ä»¥çœ‹å‡ºæˆ‘ä»¬éœ€è¦å† 1~5 é˜¶æ®µå¯¹topScrollView å’Œ bottomScrollView è¿›è¡Œè°ƒæ•´

##### 1åŒºé—´
è¿™ä¸ªæ—¶å€™ MainScrollView çš„ contentOffetY <= 0(*åç»­ä½¿ç”¨ offsetY ä»£è¡¨ MainScrollView çš„ contentOffsetY*)
è¿™ä¸ªé˜¶æ®µæ˜¯ MainScrollView çš„æ­£å¸¸æ»šåŠ¨é˜¶æ®µï¼ŒcontentView.topç­‰äº0ï¼ŒtopScrollView å’Œ bottomScrollView ä¸æ»šåŠ¨
``` swift
self.contentView.top = 0
self.topScrollView?.contentOffset = .zero
self.bottomScrollView?.contentOffset = .zero
```
##### 2åŒºé—´
è¿™ä¸ªæ—¶å€™ offsetY
``` swift
0 < offsetY <= topScrollView.contentSize.height - topScrollView.height
```
è¿™ä¸ªé˜¶æ®µ MainScrollView çš„æ»šåŠ¨å°±æ˜¯ topScrollView çš„æ»šåŠ¨ï¼Œç›´æ¥æŠŠ offetY èµ‹å€¼ç»™ topScrollView å°±å¥½äº†
ç”±äºè¿™ä¸ªé˜¶æ®µ MainScrollView çš„å¯è§†èŒƒå›´æ˜¯ offsetY ~ offsetY+MainScrollView.Height, å¦‚æœè¿™æ—¶è®© topScrollView å®Œå…¨æ˜¾ç¤ºåœ¨çª—å£ï¼Œé‚£ä¹ˆå°±ç›´æ¥è®¾ç½® contentView.top = offsetY
åŒæ—¶åœ¨è¿™ä¸ªåŒºé—´å†… bottomScrollView æ— æ³•æ»šåŠ¨ï¼Œé‚£ä¹ˆå®ƒçš„ contentOffstY è¿˜æ˜¯ä¿æŒ 0 ä¸å˜ï¼›
``` swift
self.contentView.top = offsetY
self.topScrollView?.contentOffset = CGPoint(x: 0, y: offsetY)

self.bottomScrollView?.contentOffset = .zero
/// top vc è·ç¦»åº•éƒ¨çš„è·ç¦»
let distance = topScrollViewContentHeight - topScrollViewHeight - offsetY
if direction == .up {
    delegate?.mixShortViewController(self, topVCWillDisappear: topViewController)
}

if direction == .down {
    delegate?.mixShortViewController(self, topVCDidAppear: topViewController)
}
```
##### 3 åŒºé—´
è¿™ä¸ªæ—¶å€™ offsetY
``` swift
topScrollView.contentSize.height - topScrollView.height < offsetY <= topScrollViewContentHeight
```
è¿™ä¸ªæ—¶å€™ topScrollView å·²ç»æ»šåŠ¨åˆ°äº†åº•éƒ¨ï¼Œä¸å†æ»šåŠ¨ï¼Œé‚£ä¹ˆæ­¤æ—¶ topScrollView çš„ contentOffset å°±æ˜¯å®ƒå¯ä»¥æ»šåŠ¨çš„æœ€å¤§å€¼ topScrollViewContentHeight - topScrollViewHeight
ç”±äºè¿™ä¸ªåŒºé—´æ˜¯ MainScrollView æ»šåŠ¨åŒºé—´ï¼Œç•Œé¢çš„æ»šåŠ¨å°±æ˜¯ MainScrollView çš„æ»šåŠ¨ï¼ŒcontentView çš„ top ç›´æ¥ä¿æŒ2åŒºé—´æœ€åçš„ä½ç½®å°±å¥½äº†å³ topScrollViewContentHeight - topScrollViewHeight
ç”±äºè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰åˆ° bottomScrollView çš„å¯æ»šåŠ¨çš„åŒºé—´ï¼Œé‚£ä¹ˆ bottomScrollView çš„ contentOffset è¿˜æ˜¯ 0
> è¿™ä¸ªæ—¶å€™ bottomScrollView æ­£åœ¨è¢« MainScrollView ä»åº•éƒ¨ä¸€ç‚¹ç‚¹çš„æ»‘å‡º

```swift
self.contentView.top = topScrollViewContentHeight - topScrollViewHeight
self.bottomScrollView?.contentOffset = .zero
self.topScrollView?.contentOffset = CGPoint(x: 0, y: topScrollViewContentHeight - topScrollViewHeight)
            
guard let bottomViewController = bottomViewController else { return }
delegate?.mixShortViewController(self, bottomVCDidShow: bottomViewController)
```

##### 4åŒºé—´
è¿™ä¸ªæ—¶å€™ offsetY
```swift
topScrollViewContentHeight < offsetY <= topScrollViewContentHeight + bottomScrollViewContentHeight - bottomScrollViewHeight
```
åœ¨è¿™ä¸ªåŒºé—´ bottomScrollView å¯ä»¥æ»šåŠ¨äº†ï¼Œæ­¤æ—¶å®ƒçš„ contentOffsetY å°±æ˜¯ offsetY -  topScrollViewContentHeight
åŒæ—¶è¿™ä¸ªæ—¶å€™ bottomScrollView å®Œå…¨å¤„äº MainScrollView çš„å¯è§†åŒºé—´ï¼Œé‚£ä¹ˆ contentView.top ç­‰äº offsetY - topScrollViewHeight
æ­¤æ—¶ topScrollView å®Œå…¨ä¸å¯è§äº†ï¼Œå®ƒçš„ contentOffsetä¿æŒä¸å˜å°±å¯ä»¥äº†
``` swift
self.contentView.top = offsetY - topScrollViewHeight
self.bottomScrollView?.contentOffset = CGPoint(x: 0, y: offsetY - topScrollViewContentHeight)
self.topScrollView?.contentOffset = CGPoint(x: 0, y: topScrollViewContentHeight - topScrollViewHeight)

guard let bottomViewController = bottomViewController else { return }
delegate?.mixShortViewController(self, topVCDidDisappear: bottomViewController)
```
##### 5åŒºé—´
è¿™ä¸ªæ—¶å€™ offsetY
```swift
topScrollViewContentHeight + bottomScrollViewContentHeight - bottomScrollViewHeight < offset <= topScrollViewContentHeight + bottomScrollViewContentHeight
```
è¿™ä¸ªæ—¶å€™ bottomScrollView ä¹Ÿæ»šåŠ¨åˆ°äº†å®ƒçš„åº•éƒ¨(Main ScrollView ä¹Ÿæ»‘åŠ¨åˆ°åº•éƒ¨äº†)ï¼Œè¿™ä¸ªæ—¶å€™åªæœ‰ MainScrollView å¯ä»¥æ»šåŠ¨
è¿™ä¸ªæ—¶å€™ bottomScrollView çš„ contentOffset å°±æ˜¯å®ƒçš„æœ€å¤§å¯ä»¥æ»šåŠ¨çš„å€¼å³ topScrollViewContentHeight + bottomScrollViewContentHeight - bottomScrollViewHeight
è¿™ä¸ªæ—¶å€™ Main ScrollView çš„å¯è§åŒºåŸŸ offsetY ~ offsetY + bottomScrollViewHeight, è¿™ä¸ªæ—¶å€™ç•Œé¢çš„æ»šåŠ¨å°±æ˜¯ Main ScrollView çš„æ»šåŠ¨ï¼Œè¿™æ—¶å€™ contentView ç›´æ¥ä¿æŒä¸Šä¸€é˜¶æ®µæœ€åçš„ä½ç½®å°±å¯ä»¥äº†
å³ topScrollViewContentHeight + bottomScrollViewContentHeight - bottomScrollViewHeight - topScrollViewHeight

```swift
self.contentView.top = mainScrollView.contentSize.height - self.contentView.height
self.topScrollView?.contentOffset = CGPoint(x: 0, y: topScrollViewContentHeight - topScrollViewHeight)
self.bottomScrollView?.contentOffset = CGPoint(x: 0, y: bottomScrollViewContentHeight - bottomScrollViewHeight)
```
##### 6åŒºé—´
å¦‚æœåœ¨ bottomScrollView åé¢è¿˜æœ‰å…¶ä»– subView éœ€è¦æ¥å…¥å¯ä»¥ç»§ç»­è¿›è¡Œåˆ†ææ·»åŠ 

#### ä½¿ç”¨
æˆ‘åœ¨è¿™ä¸ªä»“åº“ [https://github.com/panshimin/TTShortContainer](https://github.com/panshimin/TTShortContainer) å±•ç¤ºäº†çŸ­å®¹å™¨çš„å®ç°ï¼ŒåŒæ—¶ä¹Ÿæ¼”ç¤ºäº†çŸ­å®¹å™¨å¦‚ä½•ä½¿ç”¨   
ä¸‹é¢æˆ‘ç®€è¦çš„èŠèŠçŸ­å®¹å™¨æ˜¯å¦‚ä½•ä½¿ç”¨çš„   
çŸ­å®¹å™¨æ”¯æŒç›´æ¥ä»¥é¡µé¢(UIViewController)çš„æ–¹å¼ç›´æ¥æ¥å…¥, åªè¦é¡µé¢å®ç°äº†ä¸‹é¢è¿™ä¸ªåè®®å³å¯
``` swift
public protocol TTShortScrollViewProvider: AnyObject {
    /// Return the scrollView in the target content view controller.
    func shortScrollView() -> UIScrollView?
}

/// ä¾‹å¦‚åœ¨å›ç­”é¡µé¢ï¼Œè®©å›ç­”é¡µå®ç° TTShortScrollViewProvider åè®®ï¼Œè¿”å› webView ä½¿ç”¨çš„ scrollView å°±å¯ä»¥æ¥å…¥äº†
extension AnswerViewController: TTShortScrollViewProvider {
    /// è¿”å›ä¸€ä¸ªå†…éƒ¨ä½¿ç”¨çš„ scrollView
    public func shortScrollView() -> UIScrollView? {
        return answerView?.hybridWebViewController?.webView.scrollView
    }
}

/// åŒç†åœ¨åˆ—è¡¨é¡µé¢ï¼Œä¹Ÿæ˜¯ç›´æ¥å®ç° TTShortScrollViewProvider åè®®å°±å¯ä»¥æ¥å…¥äº†
extension MixShortPicTextListViewController: TTShortScrollViewProvider {    
    /// è¿”å›åˆ—è¡¨é¡µé¢ä¸­çš„ UICollectionView, UICollectionView æ˜¯ UIScrollView çš„å­ç±»
    public func shortScrollView() -> UIScrollView? {
        return collectionView
    }
}

```
ä¸ºäº†ä¿æŒçŸ­å®¹å™¨æ¡†æ¶çš„å¹²å‡€å’Œç‹¬ç«‹
æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªèƒ¶æ°´å±‚ï¼Œåœ¨èƒ¶æ°´å±‚å®ç° TopViewController å’Œ BottomViewController æ¥å…¥çŸ­å®¹å™¨, åŒæ—¶ä¹Ÿåœ¨èƒ¶æ°´å±‚å¤„ç†å„ç§ä¸šåŠ¡é€»è¾‘
``` swift
func setupShortViewController() {
    view.backgroundColor = UIColor.white
    let topVC = TopViewController()
    shortViewController = TTShortViewController(viewController: topVC)
    guard let shortViewController = shortViewController else {
        return
    }

    shortViewController.dataSource = self
    shortViewController.delegate = self
    shortViewController.view.backgroundColor = UIColor.white

    let statusBarHeight = Self.calculateStatusBarHeight()
    let navigtionBarHeight = Self.calculateNavitationBarHeight()
    shortViewController.view.frame = CGRect(x: 0,
                                            y: statusBarHeight + navigtionBarHeight,
                                            width: self.view.width,
                                            height: self.view.height)

    addChild(shortViewController)
    view.addSubview(shortViewController.view)
    shortViewController.didMove(toParent: self)
}

/// åŒæ—¶åœ¨èƒ¶æ°´å±‚å®ç° TTShortViewControllerDataSource åè®®ï¼Œä¸ºçŸ­å®¹å™¨æä¾› BottomViewController
public protocol TTShortViewControllerDataSource: AnyObject {
    
    func shortViewController(_ shortViewController: TTShortViewController,
                                viewControllerAfter viewController: TTShortContentViewController) -> TTShortContentViewController?
}
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯¹ä¸šåŠ¡æ²¡æœ‰ä¾µå…¥ï¼Œä¸šåŠ¡æ¥å…¥å®¹å™¨æ— æ„ŸçŸ¥ï¼ŒåŒæ—¶å¯¹ä¸šåŠ¡æ— å½±å“ï¼›


##### ä¸šåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

ç”±äº topViewController å’Œ bottomViewController åœ¨æ¥å…¥çŸ­å®¹å™¨ä¹‹åï¼Œå¯ä»¥åœ¨å®¹å™¨ä¸­ä¸Šä¸‹æ»šåŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦åœ¨çŸ­å®¹å™¨ä¸­è‡ªå®šä¹‰é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸ

``` swift
public protocol TTShortViewControllerDelegate: AnyObject {
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             didScrollToBottomContainer viewController: TTShortContentViewController)
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             bottomVCDidShow viewController: TTShortContentViewController)
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             topVCDidAppear viewController: TTShortContentViewController)
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             topVCWillDisappear viewController: TTShortContentViewController)
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             topVCDidDisappear viewController: TTShortContentViewController)
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             didScrollViewScroll scrollView: UIScrollView,
                             with direction: TTShortScrollDirection)
    
    func shortViewController(_ shortViewController: TTShortViewController,
                             scrollViewDidEndScrolling scrollView: UIScrollView)
}
```

#### ä»£ç 

å¤§å®¶å¯ä»¥ä¸‹è½½ä»£ç æŠŠç©ä¸€ä¸‹ githubï¼š[https://github.com/panshimin/TTShortContainer](https://github.com/panshimin/TTShortContainer)   
Example ç›®å½•é‡Œé¢æ”¾çš„æ˜¯ Demo æ¼”ç¤ºäº†çŸ­å®¹å™¨çš„ä½¿ç”¨ï¼›   
Source  é‡Œé¢å­˜åœ¨çš„æ˜¯çŸ­å®¹å™¨çš„æºç ï¼›

#### çŸ­å®¹å™¨çš„æ•ˆæœ
ä½¿ç”¨çŸ­å®¹å™¨å±•ç¤ºå’Œå¼€å¤´é•¿å®¹å™¨ç›¸åŒçš„å†…å®¹çš„æ•ˆæœå¦‚ä¸‹ï¼š
![çŸ­å®¹å™¨_video](/img/2022-12-10/mix_video.gif)

ä» 2 ä¸ª gif çš„å±•ç¤ºæ•ˆæœæ¥çœ‹ï¼ŒçŸ­å®¹å™¨æ»šåŠ¨æ›´æµç•…ï¼Œåœ¨ä¸€å±ä¹‹å†…å±•ç¤ºçš„å†…å®¹æ›´å¤šï¼›
ä¸Šçº¿ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ ab å®éªŒå¯¹æ¯”é•¿å®¹å™¨ï¼ŒçŸ­å®¹å™¨å–å¾—ä¸€äº›æˆæœï¼š   
1ã€ç”¨æˆ·é˜…è¯»æ—¶é•¿æå‡ 3.6%ï¼›   
2ã€adload æå‡ 5.8%ï¼ˆæ²¡äº†ç•™ç™½ã€åœ¨åˆ—è¡¨ä¸Š 5 ä¸ªå†…å®¹ä¸­æ’å…¥ 1 ä¸ªå¹¿å‘Š ğŸ˜ï¼‰ï¼›   
3ã€æ¯å¤©çš„ cardshow è¾¾åˆ° 4.5+ äº¿ï¼Œæ˜¯é™¤äº†æ¨èé¡µä¹‹å¤– cardshow æœ€é«˜çš„æ¶ˆè´¹åœºæ™¯ï¼›



















